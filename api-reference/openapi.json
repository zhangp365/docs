{
  "openapi": "3.0.3",
  "info": {
    "title": "TensorAI User Subscription Service API",
    "description": "User Subscription Service - Supabase Edge Function\n\nThis Edge Function provides user-centric subscription management:\n- User profile and subscription status management\n- Subscription creation and status tracking\n- Payment status synchronization with Stripe\n- Credit balance management\n\n## Authentication\n\nAll endpoints (except `/health`) require a valid Clerk JWT token in the Authorization header:\n\n```\nAuthorization: Bearer <clerk_jwt_token>\n```\n\n## Base URL\n\n```\nhttps://your-project.supabase.co/functions/v1/tl-service\n```",
    "version": "1.0.0",
    "contact": {
      "name": "TensorAI Team",
      "email": "support@tensorai.com"
    }
  },
  "servers": [
    {
      "url": "https://your-project.supabase.co/functions/v1/tl-service",
      "description": "Production"
    },
    {
      "url": "http://localhost:54321/functions/v1/tl-service",
      "description": "Local Development"
    }
  ],
  "security": [
    {
      "BearerAuth": []
    }
  ],
  "components": {
    "securitySchemes": {
      "BearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "Clerk JWT token for authentication"
      }
    },
    "schemas": {
      "UserProfile": {
        "type": "object",
        "description": "User profile with subscription and credit information",
        "properties": {
          "user_id": {
            "type": "string",
            "description": "User ID from Clerk"
          },
          "user_email": {
            "type": "string",
            "format": "email",
            "description": "User email address"
          },
          "user_name": {
            "type": "string",
            "description": "User display name"
          },
          "currency": {
            "type": "string",
            "description": "User's preferred currency (default: USD)"
          },
          "subscription_status": {
            "type": "string",
            "enum": [
              "active",
              "trialing",
              "past_due",
              "canceled",
              "incomplete",
              "incomplete_expired"
            ],
            "description": "Current subscription status"
          },
          "subscription_product_id": {
            "type": "string",
            "nullable": true,
            "description": "Stripe product ID"
          },
          "subscription_price_id": {
            "type": "string",
            "nullable": true,
            "description": "Stripe price ID"
          },
          "subscription_current_period_start": {
            "type": "string",
            "format": "date-time",
            "nullable": true
          },
          "subscription_current_period_end": {
            "type": "string",
            "format": "date-time",
            "nullable": true
          },
          "stripe_customer_id": {
            "type": "string",
            "nullable": true,
            "description": "Stripe customer ID"
          },
          "credit_balance": {
            "type": "number",
            "description": "Current credit balance"
          },
          "last_synced_at": {
            "type": "string",
            "format": "date-time",
            "nullable": true
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time"
          }
        },
        "required": [
          "user_id",
          "user_email",
          "currency",
          "subscription_status",
          "credit_balance"
        ]
      },
      "Price": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "description": "Stripe price ID"
          },
          "unit_amount": {
            "type": "number",
            "description": "Price in smallest currency unit (e.g., cents for USD)"
          },
          "currency": {
            "type": "string",
            "description": "ISO 4217 currency code"
          },
          "interval": {
            "type": "string",
            "enum": [
              "month",
              "year"
            ],
            "nullable": true
          },
          "interval_count": {
            "type": "number",
            "description": "Number of intervals between billing cycles"
          },
          "type": {
            "type": "string",
            "description": "Price type (e.g., recurring, one_time)"
          },
          "active": {
            "type": "boolean",
            "description": "Whether the price is active"
          },
          "metadata": {
            "type": "object",
            "additionalProperties": true
          }
        }
      },
      "Plan": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "description": "Stripe product ID"
          },
          "name": {
            "type": "string",
            "description": "Plan name"
          },
          "description": {
            "type": "string",
            "nullable": true
          },
          "prices": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/Price"
            }
          },
          "features": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "List of plan features"
          },
          "metadata": {
            "type": "object",
            "additionalProperties": true
          },
          "is_active": {
            "type": "boolean"
          }
        }
      },
      "Subscription": {
        "type": "object",
        "properties": {
          "status": {
            "type": "string",
            "description": "Subscription status"
          },
          "productId": {
            "type": "string",
            "nullable": true
          },
          "priceId": {
            "type": "string",
            "nullable": true
          },
          "current_period_start": {
            "type": "string",
            "format": "date-time",
            "nullable": true
          },
          "current_period_end": {
            "type": "string",
            "format": "date-time",
            "nullable": true
          }
        }
      },
      "SubscribeRequest": {
        "type": "object",
        "required": [
          "priceId"
        ],
        "properties": {
          "priceId": {
            "type": "string",
            "description": "Stripe price ID for the desired subscription plan"
          },
          "successUrl": {
            "type": "string",
            "format": "uri",
            "description": "URL to redirect to after successful payment",
            "default": "https://example.com/success"
          },
          "cancelUrl": {
            "type": "string",
            "format": "uri",
            "description": "URL to redirect to if payment is canceled",
            "default": "https://example.com/cancel"
          }
        }
      },
      "SubscribeResponse": {
        "type": "object",
        "properties": {
          "checkoutUrl": {
            "type": "string",
            "format": "uri",
            "description": "Stripe Checkout URL for the user to complete payment"
          },
          "stripeCustomerId": {
            "type": "string"
          },
          "sessionId": {
            "type": "string",
            "description": "Stripe Checkout Session ID"
          },
          "mode": {
            "type": "string",
            "enum": [
              "subscription",
              "payment"
            ],
            "description": "Checkout mode based on price type"
          },
          "requestId": {
            "type": "string"
          }
        }
      },
      "ChangeSubscriptionRequest": {
        "type": "object",
        "required": [
          "priceId"
        ],
        "properties": {
          "priceId": {
            "type": "string",
            "description": "Target price ID to change to (must be non-metered recurring price)"
          }
        }
      },
      "ChangeSubscriptionResponse": {
        "type": "object",
        "properties": {
          "mode": {
            "type": "string",
            "example": "update"
          },
          "subscription_id": {
            "type": "string"
          },
          "latest_invoice_id": {
            "type": "string"
          },
          "hosted_invoice_url": {
            "type": "string",
            "format": "uri",
            "description": "URL to view/pay the proration invoice"
          },
          "requestId": {
            "type": "string"
          }
        }
      },
      "UsageEventRequest": {
        "type": "object",
        "required": [
          "credits"
        ],
        "properties": {
          "credits": {
            "type": "number",
            "minimum": 0,
            "exclusiveMinimum": true,
            "description": "Number of credits consumed"
          },
          "api_name": {
            "type": "string",
            "description": "Name of the API being used"
          },
          "properties": {
            "type": "object",
            "additionalProperties": true,
            "description": "Additional event properties"
          }
        }
      },
      "CustomerPortalRequest": {
        "type": "object",
        "properties": {
          "return_url": {
            "type": "string",
            "format": "uri",
            "description": "URL to redirect to after leaving the portal",
            "default": "https://example.com"
          }
        }
      },
      "CustomerPortalResponse": {
        "type": "object",
        "properties": {
          "url": {
            "type": "string",
            "format": "uri",
            "description": "Customer portal URL"
          },
          "sessionId": {
            "type": "string"
          },
          "requestId": {
            "type": "string"
          }
        }
      },
      "ErrorResponse": {
        "type": "object",
        "properties": {
          "error": {
            "type": "string",
            "description": "Error message"
          },
          "message": {
            "type": "string",
            "nullable": true
          },
          "status": {
            "type": "number",
            "nullable": true
          },
          "requestId": {
            "type": "string",
            "nullable": true
          }
        }
      },
      "HealthResponse": {
        "type": "object",
        "properties": {
          "status": {
            "type": "string",
            "example": "ok"
          }
        }
      }
    }
  },
  "paths": {
    "/health": {
      "get": {
        "tags": [
          "Health"
        ],
        "summary": "Health check endpoint",
        "description": "Check if the service is running. No authentication required.",
        "security": [],
        "responses": {
          "200": {
            "description": "Service is healthy",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HealthResponse"
                }
              }
            }
          }
        }
      }
    },
    "/me": {
      "get": {
        "tags": [
          "User"
        ],
        "summary": "Get current user profile",
        "description": "Retrieve the authenticated user's profile with subscription status and credit balance. Automatically syncs subscription status and credits from Stripe.",
        "responses": {
          "200": {
            "description": "User profile retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "user": {
                      "$ref": "#/components/schemas/UserProfile"
                    },
                    "created": {
                      "type": "boolean",
                      "description": "Whether the user was just created"
                    },
                    "requestId": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - invalid or missing JWT token",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/plans": {
      "get": {
        "tags": [
          "Plans"
        ],
        "summary": "Get available subscription plans",
        "description": "Retrieve all active subscription plans with pricing. The Usage_Based product is automatically included with subscriptions and is not listed separately.",
        "responses": {
          "200": {
            "description": "Plans retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "plans": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/Plan"
                      }
                    },
                    "pagination": {
                      "type": "object",
                      "nullable": true
                    },
                    "requestId": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "500": {
            "description": "Failed to retrieve plans",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/credit_balance": {
      "get": {
        "tags": [
          "User"
        ],
        "summary": "Get credit balance",
        "description": "Retrieve the current user's credit balance.",
        "responses": {
          "200": {
            "description": "Credit balance retrieved",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "credit_balance": {
                      "type": "number"
                    },
                    "requestId": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "500": {
            "description": "Failed to get credit balance",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/querySubscription": {
      "get": {
        "tags": [
          "Subscription"
        ],
        "summary": "Query subscription status",
        "description": "Retrieve the current user's subscription status. Automatically syncs with Stripe for the latest status.",
        "responses": {
          "200": {
            "description": "Subscription status retrieved",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "subscription": {
                      "$ref": "#/components/schemas/Subscription"
                    },
                    "requestId": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "500": {
            "description": "Failed to query subscription",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/subscribe": {
      "post": {
        "tags": [
          "Subscription"
        ],
        "summary": "Create a new subscription",
        "description": "Initiate a new subscription by creating a Stripe Checkout Session.\n\n**Important Notes:**\n- Returns a Stripe Checkout URL for the user to complete payment\n- If the selected price is a recurring subscription, the Usage_Based metered price is automatically added\n- A Stripe customer is created if one doesn't exist\n- The user will be redirected to `successUrl` after payment or `cancelUrl` if canceled",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/SubscribeRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Checkout session created",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SubscribeResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad request - missing or invalid priceId",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "500": {
            "description": "Failed to create subscription",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/change_subscription": {
      "post": {
        "tags": [
          "Subscription"
        ],
        "summary": "Change subscription plan",
        "description": "Change the current subscription to a different plan.\n\n**Important Notes:**\n- The target price must be a non-metered recurring price\n- Billing cycle is prorated and starts immediately\n- Returns an invoice URL for any proration charges\n- Payment is required if there's a proration charge",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/ChangeSubscriptionRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Subscription changed",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ChangeSubscriptionResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad request - no active subscription, invalid price, or metered price",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "500": {
            "description": "Failed to change subscription",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/usage_event": {
      "post": {
        "tags": [
          "Usage"
        ],
        "summary": "Report API usage event",
        "description": "Send a usage event to Stripe Meter for billing.\n\n**Important Notes:**\n- Creates a meter event in Stripe with the specified credit value\n- Also logs the event locally in `tl_usage_events` table\n- Used for pay-as-you-go billing based on API usage",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/UsageEventRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Usage event recorded",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "status": {
                      "type": "string",
                      "example": "ok"
                    },
                    "event_id": {
                      "type": "string",
                      "description": "Stripe meter event ID"
                    },
                    "requestId": {
                      "type": "string"
                    },
                    "data": {
                      "type": "object",
                      "description": "Full Stripe response"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Bad request - missing credits, no stripe_customer_id",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "500": {
            "description": "Failed to send usage event",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/customer_portal": {
      "post": {
        "tags": [
          "Subscription"
        ],
        "summary": "Create customer portal session",
        "description": "Generate a Stripe Customer Portal URL for the user to manage their subscription.\n\n**Important Notes:**\n- Allows users to view invoices, update payment methods, and cancel subscriptions\n- Requires a configured Stripe Customer Portal (set via STRIPE_CUSTOMER_PORTAL env var)\n- User must have an existing Stripe customer ID",
        "requestBody": {
          "required": false,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CustomerPortalRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Portal session created",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CustomerPortalResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad request - no stripe_customer_id",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "404": {
            "description": "No Stripe customer found or portal not configured",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "500": {
            "description": "Failed to create portal session",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    }
  },
  "tags": [
    {
      "name": "Health",
      "description": "Health check endpoints"
    },
    {
      "name": "User",
      "description": "User profile management"
    },
    {
      "name": "Plans",
      "description": "Subscription plans and pricing"
    },
    {
      "name": "Subscription",
      "description": "Subscription management"
    },
    {
      "name": "Usage",
      "description": "Usage tracking and billing"
    }
  ]
}